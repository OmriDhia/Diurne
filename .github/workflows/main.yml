name: diurne_ultra_secure_deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'vite.config.js'
      - '.htaccess'

env:
  TARGET_DIR: /var/www/html/diurne_vuejs
  BUILD_DIR: dist
  TIMEOUT: 300s

jobs:
  pre_deploy_checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify critical files
        run: |
          [ -f "vite.config.js" ] || { echo "❌ vite.config.js missing"; exit 1; }
          [ -f ".htaccess" ] || { echo "❌ .htaccess missing"; exit 1; }
          echo "✅ All critical files present"

      - name: Security audit
        run: npm audit --production

  build:
    needs: pre_deploy_checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --omit=dev

      - name: Build project
        run: |
          npm run build
          [ -f "$BUILD_DIR/index.html" ] || { echo "❌ Build failed - no index.html"; exit 1; }
          echo "✅ Build successful"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build
          path: ${{ env.BUILD_DIR }}

      - name: Secure SCP transfer
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          port: 22
          source: "${{ env.BUILD_DIR }}/*"
          target: "${{ env.TARGET_DIR }}"
          strip_components: 1
          overwrite: true
          verbose: true

      - name: Post-deploy verification
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          script: |
            # Verify files were transferred
            [ -f "${{ env.TARGET_DIR }}/index.html" ] || exit 1
            [ -f "${{ env.TARGET_DIR }}/.htaccess" ] || exit 1
            
            # Set secure permissions
            sudo find "${{ env.TARGET_DIR }}" -type f -exec chmod 644 {} \;
            sudo find "${{ env.TARGET_DIR }}" -type d -exec chmod 755 {} \;
            sudo chown -R www-data:www-data "${{ env.TARGET_DIR }}"
            
            # Restart Apache gracefully
            sudo systemctl reload apache2
            echo "✅ Deployment successful"

  post_deploy:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Health check
        run: |
          curl -sSf https://yourdomain.com > /dev/null || exit 1
          echo "✅ Service is up and running"