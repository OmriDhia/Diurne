name: Deploy Vue.js Application
on:
  push:
    branches: [main]

jobs:
  deploy_job:
    runs-on: ubuntu-latest
    name: Secure Deployment
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Étape 1: Créer une archive locale (plus sécurisé que copier des fichiers individuels)
      - name: Create build artifact
        run: |
          npm install
          npm run build
          tar -czf dist.tar.gz -C dist .

      # Étape 2: Nettoyer l'environnement distant de manière sécurisée
      - name: Prepare remote directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          port: 22
          script: |
            # Crée un backup du déploiement actuel (rollback possible)
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            BACKUP_DIR="/var/www/html/backups/diurne_vuejs_$TIMESTAMP"
            mkdir -p "$BACKUP_DIR"
            [ -d "/var/www/html/diurne_vuejs" ] && mv /var/www/html/diurne_vuejs/* "$BACKUP_DIR/" || true
            
            # Crée le répertoire proprement
            mkdir -p /var/www/html/diurne_vuejs
            chown -R ubuntu:ubuntu /var/www/html/diurne_vuejs

      # Étape 3: Transfert sécurisé de l'archive
      - name: Secure transfer
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          port: 22
          source: "dist.tar.gz"
          target: "/var/www/html/diurne_vuejs/"
          rm: true  # Supprime l'archive après transfert

      # Étape 4: Déploiement avec vérifications
      - name: Deploy and verify
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          port: 22
          script: |
            cd /var/www/html/diurne_vuejs
            
            # Extraction sécurisée
            tar -xzf dist.tar.gz --no-overwrite-dir
            rm dist.tar.gz
            
            # Vérification du déploiement
            if [ ! -f "index.html" ]; then
              echo "ERREUR: Le fichier index.html est manquant!"
              exit 1
            fi
            
            # Correction des permissions
            chmod -R 755 .
            chown -R ubuntu:ubuntu .
            
            # Redémarrage contrôlé
            sudo systemctl reload apache2
            echo "Déploiement réussi et vérifié"