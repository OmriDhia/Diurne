name: diurne_secure_deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'vite.config.js'
      - '.htaccess'

env:
  TARGET_DIR: /var/www/html/diurne_vuejs
  BUILD_DIR: dist
  TIMEOUT: 300s 

jobs:
  pre_deploy_checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Validate files
        run: |
          [ -f ".htaccess" ] || { echo ".htaccess missing"; exit 1; }
          [ -d "src" ] || { echo "src directory missing"; exit 1; }

  deploy:
    needs: pre_deploy_checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (production only)
        run: npm ci --omit=dev --audit

      - name: Build project
        run: |
          npm run build
          # Vérification des artefacts critiques
          [ -f "$BUILD_DIR/index.html" ] || { echo "index.html missing"; exit 1; }
          [ -f "$BUILD_DIR/.htaccess" ] || { echo ".htaccess missing"; exit 1; }

      - name: Secure SCP transfer
        uses: appleboy/scp-action@master
        env:
          DEPLOY_KEY: ${{ secrets.DIURNE_PASSWORD }}
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          port: 22
          connect_timeout: 60
          source: "${{ env.BUILD_DIR }}/*"
          target: "${{ env.TARGET_DIR }}"
          strip_components: 1
          rm: false  # Évite la suppression brutale
          overwrite: true
          verbose: true

      - name: Remote configuration (SSH)
        uses: appleboy/ssh-action@master
        env:
          DEPLOY_KEY: ${{ secrets.DIURNE_PASSWORD }}
        with:
          host: ${{ secrets.DIURNE_HOST }}
          username: ${{ secrets.DIURNE_USERNAME }}
          password: ${{ secrets.DIURNE_PASSWORD }}
          port: 22
          script_timeout: ${{ env.TIMEOUT }}
          script: |
            # Backup avant toute modification
            backup_dir="/var/www/backups/diurne_$(date +%Y%m%d_%H%M%S)"
            sudo mkdir -p "$backup_dir"
            sudo cp -rp "${{ env.TARGET_DIR }}" "$backup_dir" || true
            
            # Sécurisation des permissions
            sudo find "${{ env.TARGET_DIR }}" -type f -exec chmod 644 {} \;
            sudo find "${{ env.TARGET_DIR }}" -type d -exec chmod 755 {} \;
            sudo chown -R www-data:www-data "${{ env.TARGET_DIR }}"
            
            # Protection des fichiers sensibles
            sudo chmod 440 "${{ env.TARGET_DIR }}/.htaccess"
            
            # Validation finale
            sudo ls -la "${{ env.TARGET_DIR }}"
            sudo systemctl reload apache2